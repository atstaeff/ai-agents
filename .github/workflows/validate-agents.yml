name: Validate Agents

on:
  push:
    paths:
      - '.github/agents/**'
      - 'skills/**'
  pull_request:
    paths:
      - '.github/agents/**'
      - 'skills/**'

jobs:
  validate-agents:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check agent files exist and have content
        run: |
          echo "ðŸ” Validating agent files..."
          ERRORS=0

          for file in .github/agents/*.agent.md; do
            if [ ! -s "$file" ]; then
              echo "âŒ Empty agent file: $file"
              ERRORS=$((ERRORS + 1))
              continue
            fi

            # Check required sections
            FILENAME=$(basename "$file")
            echo "ðŸ“„ Checking $FILENAME..."

            if ! grep -q "## Identity" "$file"; then
              echo "  âš ï¸  Missing '## Identity' section in $FILENAME"
              ERRORS=$((ERRORS + 1))
            fi

            if ! grep -q "## Core Responsibilities" "$file"; then
              echo "  âš ï¸  Missing '## Core Responsibilities' section in $FILENAME"
              ERRORS=$((ERRORS + 1))
            fi

            if ! grep -q "## Instructions" "$file"; then
              echo "  âš ï¸  Missing '## Instructions' section in $FILENAME"
              ERRORS=$((ERRORS + 1))
            fi

            if ! grep -q "## Best Practices" "$file"; then
              echo "  âš ï¸  Missing '## Best Practices' section in $FILENAME"
              ERRORS=$((ERRORS + 1))
            fi

            if ! grep -q "## Anti-Patterns" "$file"; then
              echo "  âš ï¸  Missing '## Anti-Patterns' section in $FILENAME"
              ERRORS=$((ERRORS + 1))
            fi

            if ! grep -q "## Example Prompts" "$file"; then
              echo "  âš ï¸  Missing '## Example Prompts' section in $FILENAME"
              ERRORS=$((ERRORS + 1))
            fi

            echo "  âœ… $FILENAME validated"
          done

          if [ $ERRORS -gt 0 ]; then
            echo ""
            echo "âŒ Found $ERRORS validation issues"
            exit 1
          fi

          echo ""
          echo "âœ… All agent files validated successfully"

      - name: Check skill files exist and have content
        run: |
          echo "ðŸ” Validating skill files..."
          ERRORS=0

          for file in skills/*/SKILL.md; do
            if [ ! -s "$file" ]; then
              echo "âŒ Empty skill file: $file"
              ERRORS=$((ERRORS + 1))
              continue
            fi

            FILENAME="$file"
            echo "ðŸ“„ Checking $FILENAME..."

            if ! grep -q "## Instructions for AI" "$file"; then
              echo "  âš ï¸  Missing '## Instructions for AI' section in $FILENAME"
              ERRORS=$((ERRORS + 1))
            fi

            if ! grep -q "## Best Practices" "$file"; then
              echo "  âš ï¸  Missing '## Best Practices' section in $FILENAME"
              ERRORS=$((ERRORS + 1))
            fi

            echo "  âœ… $FILENAME validated"
          done

          if [ $ERRORS -gt 0 ]; then
            echo ""
            echo "âŒ Found $ERRORS validation issues"
            exit 1
          fi

          echo ""
          echo "âœ… All skill files validated successfully"

      - name: Check for broken internal links
        run: |
          echo "ðŸ”— Checking internal links..."
          ERRORS=0

          for file in .github/agents/*.agent.md skills/*/SKILL.md; do
            # Extract markdown links to local files
            grep -oP '\[.*?\]\(((?!http).*?)\)' "$file" | grep -oP '\(([^)]+)\)' | tr -d '()' | while read -r link; do
              # Resolve relative path
              DIR=$(dirname "$file")
              TARGET="$DIR/$link"
              
              if [ ! -f "$TARGET" ]; then
                echo "  âš ï¸  Broken link in $file: $link"
                ERRORS=$((ERRORS + 1))
              fi
            done
          done

          if [ $ERRORS -gt 0 ]; then
            echo "âš ï¸  Found broken links (non-blocking)"
          else
            echo "âœ… No broken links found"
          fi

      - name: Generate summary
        run: |
          echo "## ðŸ“Š Repository Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Category | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Agents | $(ls .github/agents/*.agent.md 2>/dev/null | wc -l) |" >> $GITHUB_STEP_SUMMARY
          echo "| Skills | $(ls skills/*/SKILL.md 2>/dev/null | wc -l) |" >> $GITHUB_STEP_SUMMARY
          echo "| Marp Templates | $(ls marp-templates/*.md 2>/dev/null | wc -l) |" >> $GITHUB_STEP_SUMMARY
          echo "| Reference Repos | $(ls -d reference-repos/*/ 2>/dev/null | wc -l) |" >> $GITHUB_STEP_SUMMARY

name: CI/CD Check

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  markdown-lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Lint Markdown files
        uses: DavidAnson/markdownlint-cli2-action@v19
        with:
          globs: |
            **/*.md
            !node_modules/**
          config: |
            {
              "default": true,
              "MD013": false,
              "MD033": false,
              "MD041": false,
              "MD024": false
            }

  check-structure:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate repository structure
        run: |
          echo "üèóÔ∏è Checking repository structure..."
          ERRORS=0

          # Required directories
          REQUIRED_DIRS=(
            ".github/agents"
            "skills"
            "marp-templates"
            "docs"
          )

          for dir in "${REQUIRED_DIRS[@]}"; do
            if [ ! -d "$dir" ]; then
              echo "‚ùå Missing required directory: $dir"
              ERRORS=$((ERRORS + 1))
            else
              echo "‚úÖ Found: $dir"
            fi
          done

          # Required files
          REQUIRED_FILES=(
            "README.md"
            "LICENSE"
            "docs/README.md"
            "docs/CONTRIBUTING.md"
            "docs/GUIDELINES.md"
          )

          for file in "${REQUIRED_FILES[@]}"; do
            if [ ! -f "$file" ]; then
              echo "‚ùå Missing required file: $file"
              ERRORS=$((ERRORS + 1))
            else
              echo "‚úÖ Found: $file"
            fi
          done

          if [ $ERRORS -gt 0 ]; then
            echo ""
            echo "‚ùå Found $ERRORS structural issues"
            exit 1
          fi

          echo ""
          echo "‚úÖ Repository structure is valid"

  check-marp-templates:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate Marp templates
        run: |
          echo "üé® Checking Marp templates..."
          ERRORS=0

          for file in marp-templates/*.md; do
            if [ ! -s "$file" ]; then
              echo "‚ùå Empty template: $file"
              ERRORS=$((ERRORS + 1))
              continue
            fi

            FILENAME=$(basename "$file")
            
            if ! head -5 "$file" | grep -q "marp: true"; then
              echo "‚ö†Ô∏è  $FILENAME: Missing 'marp: true' frontmatter"
              ERRORS=$((ERRORS + 1))
            fi

            echo "‚úÖ $FILENAME is valid"
          done

          if [ $ERRORS -gt 0 ]; then
            echo ""
            echo "‚ùå Found $ERRORS template issues"
            exit 1
          fi

          echo "‚úÖ All Marp templates are valid"
